"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@react-pdf-viewer/core");function t(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var n=t(require("react")),r=function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},r.apply(this,arguments)},a=function(t){var r=t.getPageIndex,a=t.renderSpinner,i=t.doc,u=n.useState(""),o=u[0],c=u[1],l=e.useIsMounted(),s=n.useRef(),d=e.useIntersectionObserver({onVisibilityChanged:function(t){if(!o&&t.isVisible){var n=d.current;if(n){var a=i.numPages,u=r?r({numPages:a}):0,g=Math.max(0,Math.min(u,a-1));e.getPage(i,g).then((function(e){var t=e.getViewport({scale:1}),r=t.width,a=t.height,i=document.createElement("canvas"),u=i.getContext("2d",{alpha:!1}),o=n.clientWidth,d=n.clientHeight,g=Math.min(o/r,d/a),h=g*r,p=g*a;i.height=p,i.width=h,i.style.opacity="0";var m=e.getViewport({rotation:0,scale:g});s.current=e.render({canvasContext:u,viewport:m}),s.current.promise.then((function(){l.current&&c(i.toDataURL()),i.width=0,i.height=0}),(function(){}))}))}}}});return n.useEffect((function(){return function(){var e;null===(e=s.current)||void 0===e||e.cancel()}}),[]),o?n.createElement("img",{className:"rpv-thumbnail__cover-image","data-testid":"thumbnail__cover-image",src:o}):n.createElement("div",{className:"rpv-thumbnail__cover-loader","data-testid":"thumbnail__cover-loader",ref:d},a?a():n.createElement(e.Spinner,null))},i=function(t){var r=t.getPageIndex,i=t.renderSpinner,u=t.store,o=n.useState(u.get("doc")),c=o[0],l=o[1],s=function(e){l(e)};return n.useEffect((function(){return u.subscribe("doc",s),function(){u.unsubscribe("doc",s)}}),[]),n.createElement("div",{className:"rpv-thumbnail__cover"},c?n.createElement(a,{doc:c,getPageIndex:r,renderSpinner:i}):n.createElement("div",{className:"rpv-thumbnail__cover-loader"},i?i():n.createElement(e.Spinner,null)))},u=function(){return n.createElement(e.Spinner,null)},o=n.createContext({renderSpinner:u}),c=function(t){var r=t.children,a=t.doc,i=e.useIsMounted(),u=n.useState({loading:!0,labels:[]}),o=u[0],c=u[1];return n.useEffect((function(){a.getPageLabels().then((function(e){i.current&&c({loading:!1,labels:e||[]})}))}),[a.loadingTask.docId]),o.loading?n.createElement(n.Fragment,null):r(o.labels)},l=function(t){var r=t.page,a=t.pageHeight,i=t.pageIndex,u=t.pageWidth,c=t.rotation,l=t.thumbnailHeight,s=t.thumbnailWidth,d=t.onRenderCompleted,g=n.useContext(e.LocalizationContext).l10n,h=n.useRef(),p=n.useState(""),m=p[0],f=p[1],b=g&&g.thumbnail?g.thumbnail.thumbnailLabel:"Thumbnail of page {{pageIndex}}";return n.useEffect((function(){var e=h.current;e&&e.cancel();var t=document.createElement("canvas"),n=t.getContext("2d",{alpha:!1}),o=s,l=o/(u/a),g=o/u;t.height=l,t.width=o,t.style.height="".concat(l,"px"),t.style.width="".concat(o,"px");var p=r.getViewport({rotation:c,scale:g});return h.current=r.render({canvasContext:n,viewport:p}),h.current.promise.then((function(){f(t.toDataURL()),d(i)}),(function(){d(i)})),function(){var e;null===(e=h.current)||void 0===e||e.cancel()}}),[c]),m?n.createElement("img",{"aria-label":b.replace("{{pageIndex}}","".concat(i+1)),src:m,height:"".concat(l,"px"),width:"".concat(s,"px")}):n.useContext(o).renderSpinner()},s=function(t){var r=t.doc,a=t.pageHeight,i=t.pageIndex,u=t.pageRotation,c=t.pageWidth,s=t.rotation,d=t.shouldRender,g=t.thumbnailWidth,h=t.onRenderCompleted,p=t.onVisibilityChanged,m=n.useState({height:a,page:null,viewportRotation:0,width:c}),f=m[0],b=m[1],v=f.page,P=f.height,_=f.width,E=_/P,x=Math.abs(s+u)%180==0,R=x?g:g/E,C=x?g/E:g;n.useEffect((function(){d&&e.getPage(r,i).then((function(e){var t=e.getViewport({scale:1});b({height:t.height,page:e,viewportRotation:t.rotation,width:t.width})}))}),[d]);var S=(f.viewportRotation+s+u)%360,I=e.useIntersectionObserver({onVisibilityChanged:function(e){p(i,e)}});return n.createElement("div",{className:"rpv-thumbnail__container","data-testid":"thumbnail__container-".concat(i),ref:I,style:{height:"".concat(C,"px"),width:"".concat(R,"px")}},v?n.createElement(l,{page:v,pageHeight:x?P:_,pageIndex:i,pageWidth:x?_:P,rotation:S,thumbnailHeight:C,thumbnailWidth:R,onRenderCompleted:h}):n.useContext(o).renderSpinner())},d=function(t){var r=t.currentPage,a=t.doc,i=t.pagesRotation,u=t.pageHeight,o=t.pageWidth,l=t.renderCurrentPageLabel,d=t.renderThumbnailItem,g=t.rotatedPage,h=t.rotation,p=t.thumbnailWidth,m=t.onJumpToPage,f=t.onRotatePage,b=a.numPages,v=a.loadingTask.docId,P=n.useRef(null),_=n.useRef([]),E=n.useState(r),x=E[0],R=E[1],C=n.useContext(e.ThemeContext).direction===e.TextDirection.RightToLeft,S=n.useState(-1),I=S[0],w=S[1],y=e.useIsMounted(),T=n.useRef(!1),W=n.useMemo((function(){return Array(b).fill(0).map((function(e,t){return t}))}),[v]),k=n.useRef();n.useEffect((function(){var t=k.current=e.renderQueueService({doc:a,queueName:"thumbnail-list",priority:999});return function(){t.cleanup()}}),[v]);var L=function(e){switch(e.key){case"ArrowDown":H();break;case"ArrowUp":O();break;case"Enter":N()}},H=function(){if(P.current){var e=_.current,t=x+1;t<e.length&&(x>=0&&e[x].setAttribute("tabindex","-1"),R(t))}},O=function(){if(P.current){var e=_.current,t=x-1;t>=0&&(x>=0&&e[x].setAttribute("tabindex","-1"),R(t))}},N=function(){x>=0&&x<b&&m(x)};e.useIsomorphicLayoutEffect((function(){var e=P.current;e&&(_.current=Array.from(e.querySelectorAll(".rpv-thumbnail__item")))}),[]),n.useEffect((function(){var e=_.current;if(!(0===e.length||x<0||x>e.length)){var t=e[x];t.setAttribute("tabindex","0"),t.focus()}}),[x]),e.useIsomorphicLayoutEffect((function(){var e=P.current;if(e){var t=e.children;r<t.length&&function(e,t){var n=e.getBoundingClientRect().top-t.getBoundingClientRect().top,r=e.clientHeight,a=t.clientHeight;n<0?t.scrollTop+=n:n+r<=a||(t.scrollTop+=n+r-a)}(t.item(r),e)}}),[r]);var M=n.useCallback((function(e){y.current&&(k.current.markRendered(e),T.current=!1,j())}),[v]),V=n.useCallback((function(e,t){t.isVisible?k.current.setVisibility(e,t.ratio):k.current.setOutOfRange(e),j()}),[v]),j=n.useCallback((function(){if(!T.current){var e=k.current.getHighestPriorityPage();e>-1&&(k.current.markRendering(e),T.current=!0,w(e))}}),[v]);return n.useEffect((function(){g>=0&&(k.current.markRendering(g),T.current=!0,w(g))}),[v,g]),n.createElement(c,{doc:a},(function(t){return n.createElement("div",{ref:P,"data-testid":"thumbnail__list",className:e.classNames({"rpv-thumbnail__list":!0,"rpv-thumbnail__list--rtl":C}),onKeyDown:L},W.map((function(c){var g="".concat(a.loadingTask.docId,"___").concat(c),v=t.length===b?t[c]:"".concat(c+1),P=l?l({currentPage:r,pageIndex:c,numPages:b,pageLabel:v}):v,_=i.has(c)?i.get(c):0,E=n.createElement(s,{doc:a,pageHeight:u,pageIndex:c,pageRotation:_,pageWidth:o,rotation:h,shouldRender:I===c,thumbnailWidth:p,onRenderCompleted:M,onVisibilityChanged:V});return d?d({currentPage:r,key:g,numPages:b,pageIndex:c,renderPageLabel:n.createElement(n.Fragment,null,P),renderPageThumbnail:E,onJumpToPage:function(){return m(c)},onRotatePage:function(e){return f(c,e)}}):n.createElement("div",{key:g},n.createElement("div",{className:e.classNames({"rpv-thumbnail__item":!0,"rpv-thumbnail__item--selected":r===c}),role:"button",tabIndex:r===c?0:-1,onClick:function(){return m(c)}},E),n.createElement("div",{"data-testid":"thumbnail__label-".concat(c),className:"rpv-thumbnail__label"},P))})))}))},g=function(t){var r=t.renderCurrentPageLabel,a=t.renderThumbnailItem,i=t.store,u=t.thumbnailWidth,c=n.useState(i.get("doc")),l=c[0],s=c[1],g=n.useState(i.get("currentPage")||0),h=g[0],p=g[1],m=n.useState(i.get("pageHeight")||0),f=m[0],b=m[1],v=n.useState(i.get("pageWidth")||0),P=v[0],_=v[1],E=n.useState(i.get("rotation")||0),x=E[0],R=E[1],C=n.useState(i.get("pagesRotation")||new Map),S=C[0],I=C[1],w=n.useState(i.get("rotatedPage")||-1),y=w[0],T=w[1],W=function(e){p(e)},k=function(e){s(e)},L=function(e){b(e)},H=function(e){_(e)},O=function(e){R(e)},N=function(e){I(e)},M=function(e){T(e)};return n.useEffect((function(){return i.subscribe("doc",k),i.subscribe("pageHeight",L),i.subscribe("pageWidth",H),i.subscribe("rotatedPage",M),i.subscribe("rotation",O),i.subscribe("pagesRotation",N),function(){i.unsubscribe("doc",k),i.unsubscribe("pageHeight",L),i.unsubscribe("pageWidth",H),i.unsubscribe("rotatedPage",M),i.unsubscribe("rotation",O),i.unsubscribe("pagesRotation",N)}}),[]),e.useIsomorphicLayoutEffect((function(){return i.subscribe("currentPage",W),function(){i.unsubscribe("currentPage",W)}}),[]),l?n.createElement(e.LazyRender,{testId:"thumbnail__list-container",attrs:{className:"rpv-thumbnail__list-container"}},n.createElement(d,{currentPage:h,doc:l,pagesRotation:S,pageHeight:f,pageWidth:P,renderCurrentPageLabel:r,renderThumbnailItem:a,rotatedPage:y,rotation:x,thumbnailWidth:u,onJumpToPage:function(e){var t=i.get("jumpToPage");t&&t(e)},onRotatePage:function(e,t){i.get("rotatePage")(e,t)}})):n.createElement("div",{"data-testid":"thumbnail-list__loader",className:"rpv-thumbnail__loader"},n.useContext(o).renderSpinner())};exports.thumbnailPlugin=function(t){var a=n.useMemo((function(){return e.createStore({rotatePage:function(){}})}),[]),c=n.useState(""),l=c[0],s=c[1];return{install:function(e){a.update("jumpToPage",e.jumpToPage),a.update("rotatePage",e.rotatePage)},onDocumentLoad:function(e){s(e.doc.loadingTask.docId),a.update("doc",e.doc)},onViewerStateChange:function(e){return a.update("currentPage",e.pageIndex),a.update("pagesRotation",e.pagesRotation),a.update("pageHeight",e.pageHeight),a.update("pageWidth",e.pageWidth),a.update("rotation",e.rotation),a.update("rotatedPage",e.rotatedPage),e},Cover:function(e){return n.createElement(i,r({},e,{renderSpinner:null==t?void 0:t.renderSpinner,store:a}))},Thumbnails:n.useCallback((function(e){return n.createElement(o.Provider,{value:{renderSpinner:(null==t?void 0:t.renderSpinner)||u}},n.createElement(g,{renderCurrentPageLabel:null==t?void 0:t.renderCurrentPageLabel,renderThumbnailItem:null==e?void 0:e.renderThumbnailItem,store:a,thumbnailWidth:(null==t?void 0:t.thumbnailWidth)||100}))}),[l])}};
